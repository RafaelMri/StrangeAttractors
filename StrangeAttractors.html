<html>

<head>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
	<style type="text/css">
		html,
		body {
			padding: 0px;
			color: white;
			font-size: 21px;
			margin: 0px;
			overflow: hidden;
		}

		/* Bret Victor style 'Tangle' inspired links (http://worrydream.com/Tangle/) */

		a:hover {
			color: #ddf;
			border-color: #ddf;
			text-decoration: none;
		}

		a {
			color: #ddf;
			border-bottom: 1.5px dotted #ddf;
			padding: 0px 1px;
			cursor: pointer;
			text-decoration: none;
		}

		/* The modal text box is based on code from: http://www.w3schools.com/howto/howto_css_modals.asp */

		/* The Modal (background) */

		.modal {
			display: none;
			/* Hidden by default */
			position: fixed;
			/* Stay in place */
			z-index: 1;
			/* Sit on top */
			padding-top: 100px;
			/* Location of the box */
			left: 0;
			top: 0;
			width: 100%;
			/* Full width */
			height: 100%;
			/* Full height */
			overflow: auto;
			/* Enable scroll if needed */
			background-color: rgb(0, 0, 0);
			/* Fallback color */
			background-color: rgba(0, 0, 0, 0.4);
			/* Black w/ opacity */
		}

		/* Modal Content */

		.modal-content {
			background-color: #333333;
			color: #ddf;
			margin: auto;
			padding: 20px;
			border: 1px solid #888;
			width: 80%;
		}

		/* ------------------------------------------------------------------------------------------------------------------- */

		/* all of this style code just styles the input slider (autogenerated from http://www.cssportal.com/style-input-range/) */

		h1 {
			font: 400 32px/1.1em Cardo, Georgia, serif;
			/*-webkit-font-smoothing: antialiased;*/
		}

		h3 {
			font: 700 25px/1.1em Cardo, Georgia, serif;
			/*-webkit-font-smoothing: antialiased;*/
		}

		div,
		p {
			font-family: Cardo, Georgia, serif;
			/*-webkit-font-smoothing: antialiased;*/
		}

		input[type=range] {
			-webkit-appearance: none;
			margin: 0px 0;
			width: 100%;
		}

		input[type=range]:focus {
			outline: none;
		}

		input[type=range]::-webkit-slider-runnable-track {
			width: 100%;
			height: 1px;
			cursor: pointer;
			animate: 0.2s;
			box-shadow: 0px 0px 0px #858585;
			background: #3071A9;
			border-radius: 0px;
			border: 1px solid #878787;
		}

		input[type=range]::-webkit-slider-thumb {
			box-shadow: 1px 1px 1px #000000;
			border: 1px solid #000000;
			height: 16px;
			width: 16px;
			border-radius: 16px;
			background: #FFFFFF;
			cursor: pointer;
			-webkit-appearance: none;
			margin-top: -8.5px;
		}

		input[type=range]:focus::-webkit-slider-runnable-track {
			background: #3071A9;
		}

		input[type=range]::-moz-range-track {
			width: 100%;
			height: 1px;
			cursor: pointer;
			animate: 0.2s;
			box-shadow: 0px 0px 0px #858585;
			background: #3071A9;
			border-radius: 0px;
			border: 1px solid #878787;
		}

		input[type=range]::-moz-range-thumb {
			box-shadow: 1px 1px 1px #000000;
			border: 1px solid #000000;
			height: 16px;
			width: 16px;
			border-radius: 16px;
			background: #FFFFFF;
			cursor: pointer;
		}

		input[type=range]::-ms-track {
			width: 100%;
			height: 1px;
			cursor: pointer;
			animate: 0.2s;
			background: transparent;
			border-color: transparent;
			color: transparent;
		}

		input[type=range]::-ms-fill-lower {
			background: #3071A9;
			border: 1px solid #878787;
			border-radius: 0px;
			box-shadow: 0px 0px 0px #858585;
		}

		input[type=range]::-ms-fill-upper {
			background: #3071A9;
			border: 1px solid #878787;
			border-radius: 0px;
			box-shadow: 0px 0px 0px #858585;
		}

		input[type=range]::-ms-thumb {
			box-shadow: 1px 1px 1px #000000;
			border: 1px solid #000000;
			height: 16px;
			width: 16px;
			border-radius: 16px;
			background: #FFFFFF;
			cursor: pointer;
		}

		input[type=range]:focus::-ms-fill-lower {
			background: #3071A9;
		}

		input[type=range]:focus::-ms-fill-upper {
			background: #3071A9;
		}
	</style>
</head>

<body>
	<div style="position: fixed; padding: 30px;" id="ui">
		<img src="logo.png" />
		<p style="font-size: 9px">
			3D using
			<a href="https://threejs.org/">three.js</a>.

		</p>
	</div>
	<div id="container"></div>
	<script src="js/three.min.js" type="text/javascript"></script>
	<script src="js/OrbitControls.js" type="text/javascript"></script>
	<script src="js/RGBELoader.js" type="text/javascript"></script>
	<script src="js/HDRCubeTextureLoader.js" type="text/javascript"></script>

	<script src="js/Detector.js" type="text/javascript"></script>
	<script src="js/stats.min.js" type="text/javascript"></script>

	<script src="js/Half.js" type="text/javascript"></script>
	<script src="js/Encodings.js" type="text/javascript"></script>
	<script src="js/PMREMGenerator.js" type="text/javascript"></script>
	<script src="js/PMREMCubeUVPacker.js" type="text/javascript"></script>
	<script src="js/dat.gui.min.js" type="text/javascript"></script>

	<script src="js/shaders/FilmShader.js" type="text/javascript"></script>
	<script src="js/shaders/VignetteShader.js" type="text/javascript"></script>
	<script src="js/postprocessing/EffectComposer.js" type="text/javascript"></script>
	<script src="js/postprocessing/RenderPass.js" type="text/javascript"></script>
	<script src="js/postprocessing/FilmPass.js" type="text/javascript"></script>
	<script src="js/postprocessing/MaskPass.js" type="text/javascript"></script>
	<script src="js/postprocessing/ShaderPass.js" type="text/javascript"></script>
	<script src="js/postprocessing/SSAOPass.js"></script>
	<script src="js/shaders/DepthLimitedBlurShader.js"></script>
	<script src="js/shaders/UnpackDepthRGBAShader.js"></script>

	<script src="js/shaders/CopyShader.js" type="text/javascript"></script>
	<script src="js/shaders/FXAAShader.js" type="text/javascript"></script>
	<script src="js/shaders/SSAOShader.js" type="text/javascript"></script>

	<script src="js/shaders/ConvolutionShader.js" type="text/javascript"></script>
	<script src="js/shaders/LuminosityHighPassShader.js" type="text/javascript"></script>
	<script src="js/postprocessing/UnrealBloomPass.js" type="text/javascript"></script>
	<script src="AttractorCurve.js" type="text/javascript"></script>
	<script src="Attractors.js" type="text/javascript"></script>


	<div id="functionExamples" class="modal">
		<div id="functionExamplesDiv" class="modal-content">

		</div>
	</div>

	<script type="text/javascript">
		var Settings = {};

		var ui = document.getElementById('ui');

		var functionDialog = document.getElementById('functionExamples');

		var functionExamplesDiv = document.getElementById('functionExamplesDiv');

		var attractors = getAttractors();
		var attractor = attractors[0];

		functionExamplesDiv.insertAdjacentHTML('beforeend', "<h3>Select attractor</h3>");
		for (var i = 0; i < attractors.length; i++) {
			functionExamplesDiv.insertAdjacentHTML('beforeend', "<p><a href='javascript:setAttractor(" + i + ");'>" + attractors[i].getName() + "</a></p>");
		}

		function updateAttractor() {
			if (mesh !== undefined) {
				scene.remove(mesh);
				mesh.geometry.dispose();
			}
			var path = new AttractorCurve(125000, attractor);
			path.init();
			//var m = new THREE.MeshBasicMaterial();
			//m.wireframe = true;
			mesh = new THREE.Mesh(path.getGeometry(), standardMaterial);
			mesh.receiveShadow = true;
			mesh.castShadow = true;
			scene.add(mesh);
		}

		function setAttractor(index) {
			attractor = attractors[index];

			updateAttractor();

			var elem = document.querySelector('.dynamicUI');
			while (elem !== null) {
				elem.parentNode.removeChild(elem);
				elem = document.querySelector('.dynamicUI');
			}

			ui.insertAdjacentHTML('beforeend', "<div class='dynamicUI'>Attractor: <a class=toggle href='javascript:showFunctionExamples();' >" + attractor.getName() + "</a> </div>");

			for (var key in attractor) {
				if (attractor.hasOwnProperty(key)) {
					createSlider(ui, key, key, attractor[key], 0, attractor[key] * 5);
				}
			}

			functionDialog.style.display = "none";
		}

		function showFunctionExamples() {
			functionDialog.style.display = "block";
		}

		window.onclick = function (event) {
			if (event.target == functionDialog) {
				functionDialog.style.display = "none";
			}
		}

		function createSlider(container, name, label, defaultValue, min, max) {
			var html = "<div class='dynamicUI'><span id='" + name + "Label'>" + label + "&nbsp;&nbsp;</span>";
			html += "<input id='" + name + "Slider' value='" + 100 * (defaultValue - min) / (max - min) + "' type='range' min='0' max='100' style='width: 300px;'>";
			html += "&nbsp;&nbsp;<span id='" + name + "Value'>" + defaultValue.toFixed(3) + "</span></div>";
			container.insertAdjacentHTML('beforeend', html);

			var slider = document.getElementById(name + "Slider");
			var value = document.getElementById(name + "Value");
			slider.addEventListener('input', function () {
				var val = slider.value * 0.01 * (max - min) + min;
				value.innerHTML = val.toFixed(3);
				attractor[name] = val;
				updateAttractor();
			});
		}

		function createSlider2(container, name, label, defaultValue) {
			var html = "<div><span id='" + name + "Label'>" + label + "&nbsp;&nbsp;</span>";
			html += "<input id='" + name + "Slider' value='" + defaultValue + "' type='range' min='0' max='100' style='width: 300px;'>";
			html += "&nbsp;&nbsp;<span id='" + name + "Value'>" + defaultValue + "</span></div>";
			container.insertAdjacentHTML('beforeend', html);
			Settings[name] = defaultValue;

			var slider = document.getElementById(name + "Slider");
			var value = document.getElementById(name + "Value");
			slider.addEventListener('input', function () {
				Settings[name] = slider.value;
				value.innerHTML = slider.value;
				updateAttractor();
			});
		}

		ui.insertAdjacentHTML('beforeend', "<div class='dynamicUI'>Attractor: <a class=toggle href='javascript:showFunctionExamples();' >" + attractor.getName() + "</a> </div>");
		
		if (!Detector.webgl)
			Detector.addGetWebGLMessage();


		var container, stats;
		var params = {
			projection: 'normal',
			background: false,
			exposure: 1.2,
			bloomStrength: 1.9,
			bloomThreshold: 0.85,
			bloomRadius: 0.4,
			metalness: 0.1,
			onlyAO: false,
			radius: 32,
			aoClamp: 1,
			lumInfluence: 0.7,
		};
		var camera, scene, renderer, controls;
		var effectFXAA, bloomPass, renderScene;
		var hdrCubeMap;
		var composer, ssaoPass;
		var standardMaterial;
		var hdrCubeRenderTarget;
		var mesh;

		var globalMax = 0;
		init();
		updateParameters();

		animate();
		var totalSamples = 0;

		function updateParameters() {
		}


		function init() {
			container = document.createElement('div');
			document.body.appendChild(container);

			camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 2000);
			camera.position.set(0.0, 35, 35 * 3.5);

			scene = new THREE.Scene();

			renderer = new THREE.WebGLRenderer({
				antialias: false
			});
			renderer.setClearColor(new THREE.Color(0x000000));
			renderer.toneMapping = THREE.LinearToneMapping;

			standardMaterial = new THREE.MeshPhysicalMaterial({
				map: null,
				color: 0xffaa77,
				clearCoat: 1.0,
				clearCoatRoughness: 0.0,
				reflectivity: 0.1,
				metalness: 0.10,
				roughness: 0.0
			});

			

			var groundMaterial = new THREE.MeshStandardMaterial({
				map: null,
				color: 0xaaaaaa,
				metalness: 0.00,
				roughness: 1.0
			});

			// Create attractor mesh
			setAttractor(0);

			// Create a ground plane.
			var geometry = new THREE.PlaneBufferGeometry(5000, 5000, 2, 2);
			geometry.rotateX(-Math.PI / 2);
			terrainMesh = new THREE.Mesh(geometry, groundMaterial);
			terrainMesh.receiveShadow = true;
			terrainMesh.castShadow = true;
			scene.add(terrainMesh);

			var textureLoader = new THREE.TextureLoader();
			textureLoader.load("./js/roughness_map3.jpg", function (map) {
				map.wrapS = THREE.RepeatWrapping;
				map.wrapT = THREE.RepeatWrapping;
				map.anisotropy = 4;
				map.repeat.set(0.01, 0.01);
				standardMaterial.roughnessMap = map;
				standardMaterial.bumpMap = map;
				standardMaterial.needsUpdate = true;
			});

			var genCubeUrls = function (prefix, postfix) {
				return [prefix + 'px' + postfix, prefix + 'nx' + postfix, prefix + 'py' + postfix, prefix + 'ny' + postfix,
				prefix + 'pz' + postfix, prefix + 'nz' + postfix];
			};

			var hdrUrls = genCubeUrls("./js/cube/pisaHDR/", ".hdr");
			new THREE.HDRCubeTextureLoader().load(THREE.UnsignedByteType, hdrUrls, function (hdrCubeMap) {
				var pmremGenerator = new THREE.PMREMGenerator(hdrCubeMap);
				pmremGenerator.update(renderer);

				var pmremCubeUVPacker = new THREE.PMREMCubeUVPacker(pmremGenerator.cubeLods);
				pmremCubeUVPacker.update(renderer);

				hdrCubeRenderTarget = pmremCubeUVPacker.CubeUVRenderTarget;
			});

			// Lights

			scene.add(new THREE.AmbientLight(0x222222));
			scene.fog = new THREE.FogExp2(0x000000, 0.0025);

			var spotLight = new THREE.SpotLight(0xffffff);
			spotLight.position.set(50, 100, 50);
			spotLight.angle = Math.PI / 7;
			spotLight.penumbra = 0.8
			spotLight.castShadow = true;
			spotLight.shadow.mapSize.width = 2048;
			spotLight.shadow.mapSize.height = 1024;

			scene.add(spotLight);

			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.shadowMap.enabled = true;
			renderer.shadowMap.type = THREE.PCFSoftShadowMap; // default THREE.PCFShadowMap

			container.appendChild(renderer.domElement);

			renderScene = new THREE.RenderPass(scene, camera);
			effectFXAA = new THREE.ShaderPass(THREE.FXAAShader);
			effectFXAA.uniforms['resolution'].value.set(1 / window.innerWidth, 1 / window.innerHeight);

			var copyShader = new THREE.ShaderPass(THREE.CopyShader);
			copyShader.renderToScreen = true;

			var shaderVignette = THREE.VignetteShader;
			var effectVignette = new THREE.ShaderPass(shaderVignette);
			effectVignette.uniforms["offset"].value = 0.95;
			effectVignette.uniforms["darkness"].value = 2.0;
			var effectFilm = new THREE.FilmPass(0.55, 0.525, 1048, false);

			ssaoPass = new THREE.SSAOPass(scene, camera);
			ssaoPass.radius = params.radius;
			ssaoPass.aoClamp = params.aoClamp;
			ssaoPass.lumInfluence = params.lumInfluence;

			bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), params.bloomStrength, params.bloomRadius, params.bloomThreshold);//1.0, 9, 0.5, 512);
			composer = new THREE.EffectComposer(renderer);
			composer.setSize(window.innerWidth, window.innerHeight);
			composer.addPass(renderScene);

			composer.addPass(effectFXAA);
			composer.addPass(bloomPass);
			composer.addPass(effectVignette);
			composer.addPass(effectFilm);
			composer.addPass(ssaoPass);
			composer.addPass(copyShader);
			renderer.toneMapping = THREE.ReinhardToneMapping;
			renderer.gammaInput = true;
			renderer.gammaOutput = true;

			stats = new Stats();
			container.appendChild(stats.dom);

			controls = new THREE.OrbitControls(camera, renderer.domElement);
			controls.update();
			controls.autoRotate = false;
			controls.enableDamping = true;

			window.addEventListener('resize', onWindowResize, false);

			var gui = new dat.GUI();

			gui.add(params, 'exposure', 0.1, 2);
			gui.add(params, 'bloomThreshold', 0.0, 1.0).onChange(function (value) {
				bloomPass.threshold = Number(value);
			});
			gui.add(params, 'bloomStrength', 0.0, 3.0).onChange(function (value) {
				bloomPass.strength = Number(value);
			});
			gui.add(params, 'bloomRadius', 0.0, 1.0).onChange(function (value) {
				bloomPass.radius = Number(value);
			});
			gui.add(params, 'metalness', 0.0, 1.0).onChange(function (value) {
				if (mesh.material !== undefined)
					mesh.material.metalness = Number(value);
			});

			gui.add(params, 'onlyAO', false).onChange(function (value) { ssaoPass.onlyAO = value; });
			gui.add(params, 'radius').min(0).max(64).onChange(function (value) { ssaoPass.radius = value; });
			gui.add(params, 'aoClamp').min(0).max(1).onChange(function (value) { ssaoPass.aoClamp = value; });
			gui.add(params, 'lumInfluence').min(0).max(1).onChange(function (value) { ssaoPass.lumInfluence = value; });
			gui.open();
		}

		function onWindowResize() {
			var width = window.innerWidth;
			var height = window.innerHeight;

			camera.aspect = width / height;
			camera.updateProjectionMatrix();
			ssaoPass.setSize(width, height);
			renderer.setSize(width, height);
			composer.setSize(width, height);
			effectFXAA.uniforms['resolution'].value.set(1 / window.innerWidth, 1 / window.innerHeight);
		}

		function animate() {
			requestAnimationFrame(animate);
			stats.begin();
			render();
			stats.end();
		}

		function render() {
			controls.update();
			if (standardMaterial !== undefined) {
				standardMaterial.roughness = 0.1;
				standardMaterial.bumpScale = 0.0;
				var newEnvMap = standardMaterial.envMap;
				newEnvMap = hdrCubeRenderTarget ? hdrCubeRenderTarget.texture : null;
				if (newEnvMap !== standardMaterial.envMap) {
					standardMaterial.envMap = newEnvMap;
					standardMaterial.needsUpdate = true;
				}
			}
			renderer.toneMappingExposure = Math.pow(params.exposure, 4.0);
			composer.render(0.01);
		}


	</script>

</body>

</html>